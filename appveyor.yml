# appveyor.yml
---

environment:
  # Encrypted password (more precisely: token) for upload distro to pypy:
  # The "pypipw" is a custom name.
  # The original (sensitive) token is generated by the pypi: https://pypi.org/manage/account/token/
  # The token has encripted by the appveyor: https://ci.appveyor.com/tools/encrypt
  pypipw:
    secure: N+tYP6JrVCZ12LX7MUmHYJ8kx07F4A1hXtmEW01RmhrrQBdylIf0SO/eEfW5f4ox3S4xG/lgGSzNlZckvgifrsYeeBkWwoSH5/AJ3SnOJ7HBVojVt2t3bAznS6x3aPT7WDpwGN7piwus9aHSmpKaOzRoEOBKfgHv3aUzb907C0d0Yr12LU/4cIoTAn7jMziifSq45Z50lsQwzYic/VkarxTh+GXuCCm1Mb8F686H8i6Smm1Q1n9BsXowYnzwdrTZSBVOUtpd48Mh9JKgSNhfmQ==
  testpypipw:
    secure: CcyBI8e/2LdIT2aYIytTAgR4795DNBDM/ztsz1kqZYYOeNc3zlJWLdYWrnjCHn5W6/ZcAHrsxCdCMHvtr6PIVgBRpl2RR3fk2jKTzKqJJsLW871q30BsE0kws32f1IiqfjVtLn8BUC91IJ2xBBXtOYktf1tCMi3zJMSF9+MIOQKIu298bIRnD1Lc+4lzcSZJOn4I7dOMdzlcCMRqhtO58TGwR/hD+22FHjyWVB8nLL18AO+XXS9lHSOUrH6rD5NYvVFZD68oV/RrCGAjRmfMnw==
  # Set default pytohn, the real matrinx is in the tox settings.
  matrix:
  - TOXENV: py37-default
    COVERAGE_FILENAME: py37-default_coverage.xml
    COVERAGE_FILENAME: py37-legacy_wexpect_coverage.xml
    PYTHON: "C:\\Python37"
  - TOXENV: py37-spawn_pipe
    COVERAGE_FILENAME: py37-spawn_pipe_coverage.xml
    PYTHON: "C:\\Python37"
  - TOXENV: installed
    PYTHON: "C:\\Python37"
    PYTHON: "C:\\Python37"
  - TOXENV: py37-legacy_wexpect

build: off

install:
  - set PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%
  - pip install .[test]

test_script:
  - tox

after_test:
  # Upload code coverage results.
  # https://github.com/codecov/codecov-python/issues/158#issuecomment-514282362
  - IF "%COVERAGE_FILENAME%"!="" (
      (codecov --no-color -X gcov --file %COVERAGE_FILENAME% --required ) || (sleep 30 && codecov --no-color -X gcov --file %COVERAGE_FILENAME% --required )
    )
  # fill .pypirc file.
  # pypi
  - |-
      "echo [pypi] > %USERPROFILE%\\.pypirc"
      "echo repository: https://upload.pypi.org/legacy/ >> %USERPROFILE%\\.pypirc"
      "echo username: __token__ >> %USERPROFILE%\\.pypirc"
      "echo password: %pypipw% >> %USERPROFILE%\\.pypirc"
  # testpypi
  - |-
      "echo [testpypi] >> %USERPROFILE%\\.pypirc"
      "echo repository: https://test.pypi.org/legacy/ >> %USERPROFILE%\\.pypirc"
      "echo username: __token__ >> %USERPROFILE%\\.pypirc"
      "echo password: %testpypipw% >> %USERPROFILE%\\.pypirc"

  # Create source distribution.
  - python -m setup sdist

  # Upload to pypi.
  # More precisely. The master and release builds will be uploaded to pypi. Test branch will be
  # uploaded to test-pypi the test builds.
  # See more at https://stackoverflow.com/a/39155147/2506522

  - IF %APPVEYOR_REPO_BRANCH%==master (
      twine upload -r pypi dist\\wexpect*.tar.gz
    )
  - IF %APPVEYOR_REPO_TAG%==true (
      twine upload -r pypi dist\\wexpect*.tar.gz
    )
  - IF %APPVEYOR_REPO_BRANCH%==test (
      twine upload -r testpypi dist\\wexpect*.tar.gz
    )
